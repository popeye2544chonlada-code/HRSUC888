<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการเงินเดือนและวันหยุด</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let loggedInUser = null;
        let loggedInUserDepartment = null;
        let allPublicLeaves = [];
        let allAdvanceRequests = [];

        // ** Hardcoded user data for demonstration purposes only. DO NOT USE IN PRODUCTION. **
        const hardcodedUsers = {
            'suc@eyeyhaa': {
                password: '123456',
                employeeId: 'SUC001', // New employee ID field
                name: 'ชลลดา สิทธิมาตย์',
                position: 'ADD',
                department: 'ADMIN',
                startDate: '06/08/2025',
                // Salary data for calculation
                baseSalary: 18000,
                mealAllowanceRate: 100,
                travelAllowance: 1000,
                commission: 2500, // Initial commission value
                workingDays: 27,
                miscellaneousFee: 50,
                advanceDeduction: 500
            },
            'hr@eyeyhaa': {
                password: '654321',
                employeeId: 'HR001', // New employee ID field
                name: 'สมหญิง ใจดี',
                position: 'ผู้จัดการ',
                department: 'ฝ่ายบุคคล',
                startDate: '10/05/2020',
                baseSalary: 18000,
                mealAllowanceRate: 100,
                travelAllowance: 1000,
                commission: 1000,
                workingDays: 20,
                miscellaneousFee: 0,
                advanceDeduction: 0
            }
        };

        window.firebaseInit = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Please provide the config to initialize Firebase.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                console.log("Firebase initialized successfully.");

                // Check for auth state changes to show/hide the correct UI
                onAuthStateChanged(auth, async (user) => {
                    const loadingElement = document.getElementById('loading-state');
                    loadingElement.style.display = 'none';

                    if (user) {
                        loggedInUser = user;
                        const userId = user.uid;
                        
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            loggedInUserDepartment = userData.department; // Store department for later use
                            document.getElementById('login-section').style.display = 'none';
                            document.getElementById('main-app').style.display = 'block';
                            document.getElementById('user-id-display').innerText = userData.employeeId; // Changed to use employeeId
                            window.attachListeners(userId, userData);
                        } else {
                            // If a user is authenticated but no profile exists, it's a fatal error state.
                            // This should not happen with the new login flow.
                            console.error("Fatal Error: Profile document should exist but doesn't.");
                            showModal('เกิดข้อผิดพลาดในการดึงข้อมูล โปรดลองเข้าสู่ระบบใหม่');
                            signOut(auth);
                        }
                    } else {
                        console.log("User is signed out.");
                        document.getElementById('main-app').style.display = 'none';
                        document.getElementById('login-section').style.display = 'block';
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loading-state').innerText = 'ไม่สามารถเชื่อมต่อกับ Firebase ได้ กรุณาตรวจสอบการตั้งค่า';
            }
        };

        window.loginUser = async () => {
            const employeeId = document.getElementById('employee-id').value;
            const password = document.getElementById('password').value;

            const userProfile = hardcodedUsers[employeeId];
            if (userProfile && userProfile.password === password) {
                try {
                    // Sign in with custom token for a more secure flow
                    await signInWithCustomToken(auth, initialAuthToken);

                    // Get the logged in user after signing in
                    const userCredential = auth.currentUser;
                    const userId = userCredential.uid;
                    
                    // Now save the user data to Firestore
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    await setDoc(userDocRef, userProfile);

                    console.log("User data successfully created in Firestore.");
                    showModal('เข้าสู่ระบบสำเร็จ');

                } catch (e) {
                    console.error("Login error:", e);
                    showModal('เข้าสู่ระบบไม่สำเร็จ');
                }
            } else {
                showModal('รหัสพนักงานหรือรหัสผ่านไม่ถูกต้อง');
            }
        };

        window.logoutUser = async () => {
            try {
                await signOut(auth);
                showModal('ออกจากระบบสำเร็จ');
            } catch (e) {
                console.error("Logout error:", e);
                showModal('ไม่สามารถออกจากระบบได้');
            }
        };
        
        // Function to render the calendar
        const renderCalendar = (month, year, publicLeaves) => {
            const calendarDaysContainer = document.getElementById('calendar-days');
            calendarDaysContainer.innerHTML = '';
            const date = new Date(year, month, 1);
            const firstDay = date.getDay(); // 0 = Sunday, 1 = Monday
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Fill leading empty days
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2 text-center text-gray-400';
                calendarDaysContainer.appendChild(emptyCell);
            }

            // Fill days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'p-2 text-center relative border rounded-md h-16 sm:h-20 flex flex-col items-center';
                dayCell.innerHTML = `<span class="font-bold text-gray-800 text-sm sm:text-lg">${i}</span>`;
                
                const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // Find leaves for this day
                const leavesOnThisDay = allPublicLeaves.filter(leave => {
                    const startDate = new Date(leave.startDate);
                    const endDate = new Date(leave.endDate);
                    const currentDate = new Date(dayString);
                    // Check if current date is within the leave range (inclusive)
                    return currentDate >= startDate && currentDate <= endDate;
                });

                if (leavesOnThisDay.length > 0) {
                    const leavesText = document.createElement('div');
                    leavesText.className = 'absolute bottom-1 left-1 right-1 flex flex-row items-center justify-center space-x-0.5';
                    leavesOnThisDay.forEach(leave => {
                        const leaveDot = document.createElement('span');
                        leaveDot.className = `w-2 h-2 rounded-full ${leave.status === 'pending' ? 'bg-yellow-500' : 'bg-gray-400'} border border-gray-100`;
                        leavesText.appendChild(leaveDot);
                    });
                    dayCell.appendChild(leavesText);
                }
                
                calendarDaysContainer.appendChild(dayCell);
            }
        };
        
        const renderCheckinCalendar = (userId, month, year, checkinData) => {
            const calendarDaysContainer = document.getElementById('checkin-calendar-days');
            calendarDaysContainer.innerHTML = '';
            const date = new Date(year, month, 1);
            const firstDay = date.getDay(); // 0 = Sunday, 1 = Monday
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Set current month/year display
            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            document.getElementById('checkin-month-year').innerText = `${monthNames[month]} ${year}`;

            // Fill leading empty days
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2 text-center text-gray-400';
                calendarDaysContainer.appendChild(emptyCell);
            }

            // Fill days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'p-2 text-center relative border rounded-md h-16 sm:h-20 flex flex-col items-center';
                dayCell.innerHTML = `<span class="font-bold text-gray-800 text-sm sm:text-lg">${i}</span>`;
                
                const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = checkinData[dayString];
                
                if (dayData) {
                    let statusHtml = '';
                    if (dayData.checkIn) {
                        statusHtml += `<p class="text-xs text-green-500">เช็คอิน: ${dayData.checkIn}</p>`;
                    }
                    if (dayData.checkOut) {
                        statusHtml += `<p class="text-xs text-red-500">เช็คเอาท์: ${dayData.checkOut}</p>`;
                    }
                    dayCell.innerHTML += `<div class="mt-1 space-y-0.5">${statusHtml}</div>`;
                }
                
                // Add Check-in/Check-out buttons for today
                if (dayString === todayString) {
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-auto flex flex-col items-center space-y-1';
                    if (!dayData || !dayData.checkIn) {
                        buttonContainer.innerHTML = `<button onclick="checkIn()" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md">เช็คอิน</button>`;
                    } else if (!dayData.checkOut) {
                        buttonContainer.innerHTML = `<button onclick="checkOut()" class="bg-red-500 text-white text-xs px-2 py-1 rounded-md">เช็คเอาท์</button>`;
                    }
                    dayCell.appendChild(buttonContainer);
                }
                
                calendarDaysContainer.appendChild(dayCell);
            }
        };

        window.attachListeners = (userId, userData) => {
            // Display employee info
            document.getElementById('employee-name').innerText = userData.name;
            document.getElementById('employee-position').innerText = userData.position;
            document.getElementById('employee-department').innerText = userData.department;
            document.getElementById('employee-start-date').innerText = userData.startDate;
            
            // Handle payroll calculation and display
            const updatePayroll = (isPayslipVisible) => {
                const totalDeduction = userData.advanceDeduction + userData.miscellaneousFee;
                const totalIncome = userData.baseSalary + (userData.mealAllowanceRate * userData.workingDays) + userData.travelAllowance + ((userData.baseSalary / 25) * Math.max(0, userData.workingDays - 25)) + userData.commission;
                const netPay = totalIncome - totalDeduction;
                
                const payrollContentDiv = document.getElementById('payroll-list');
                const payslipStatusMessage = document.getElementById('payslip-status-message');

                if (isPayslipVisible) {
                    payslipStatusMessage.classList.add('hidden');
                    payrollContentDiv.classList.remove('hidden');
                    // Display payroll data
                    payrollContentDiv.innerHTML = `
                        <div class="space-y-2 text-gray-700">
                            <p><strong>1. ฐานเงินเดือน:</strong> ${userData.baseSalary} บาท</p>
                            <p><strong>2. ค่าข้าว (${userData.workingDays} วัน):</strong> ${userData.mealAllowanceRate * userData.workingDays} บาท</p>
                            <p><strong>3. ค่าเดินทาง:</strong> ${userData.travelAllowance} บาท</p>
                            <p><strong>4. OT (${Math.max(0, userData.workingDays - 25)} วัน):</strong> ${(userData.baseSalary / 25) * Math.max(0, userData.workingDays - 25)} บาท</p>
                            <p><strong>5. ค่าคอมมิชชั่น:</strong> <span id="commission-display">${userData.commission}</span> บาท</p>
                            <p><strong>6. ค่าทำรายการ:</strong> ${userData.miscellaneousFee} บาท</p>
                            <p class="text-red-600"><strong>7. รายการเบิก:</strong> <span id="total-advance-deduction">กำลังโหลด...</span> บาท</p>
                            <p class="text-red-600"><strong>8. หักค่าทำรายการผิด:</strong> ${userData.miscellaneousFee} บาท</p>
                            <div class="pt-4 mt-4 border-t border-gray-300">
                                <p class="text-red-600 font-bold"><strong>9. รวมหัก:</strong> ${totalDeduction} บาท</p>
                                <p class="text-green-600 font-bold"><strong>10. รวมรายได้ทั้งหมด:</strong> ${totalIncome} บาท</p>
                                <p class="text-blue-600 font-bold text-xl"><strong>11. รายรับสุทธิ:</strong> ${netPay} บาท</p>
                            </div>
                        </div>
                    `;
                } else {
                    payslipStatusMessage.classList.remove('hidden');
                    payrollContentDiv.classList.add('hidden');
                }
            };
            
            // Listen for changes in the user's profile, including the new 'isPayslipVisible' field
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const isPayslipVisible = userData.isPayslipVisible || false;
                    updatePayroll(isPayslipVisible);
                }
            });
            
            // Initial payroll calculation
            updatePayroll(userData.isPayslipVisible || false);
            
            // Show/hide HR management tab
            const hrTab = document.getElementById('tab-hr');
            const approveLeaveTab = document.getElementById('tab-approve-leave');
            const approveAdvanceTab = document.getElementById('tab-approve-advance');
            const advanceReportTab = document.getElementById('tab-advance-report');

            if (userData.department === 'ฝ่ายบุคคล') {
                hrTab.classList.remove('hidden');
                approveLeaveTab.classList.remove('hidden');
                approveAdvanceTab.classList.remove('hidden');
                advanceReportTab.classList.remove('hidden');
            } else {
                hrTab.classList.add('hidden');
                approveLeaveTab.classList.add('hidden');
                approveAdvanceTab.classList.add('hidden');
                advanceReportTab.classList.add('hidden');
            }


            // --- Calendar and Leave Requests Logic ---
            const today = new Date();
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

            const publicLeaveCollection = collection(db, `artifacts/${appId}/public/data/leave_requests_public`);
            const advanceRequestsCollection = collection(db, `artifacts/${appId}/public/data/advance_requests_public`);
            const attendanceCollection = collection(db, `artifacts/${appId}/public/data/attendance`);


            // Attach listener for both calendar and personal leave list
            onSnapshot(publicLeaveCollection, (snapshot) => {
                allPublicLeaves = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update the calendar
                renderCalendar(currentMonth, currentYear, allPublicLeaves);

                // Update the personal leave list for the current user
                const leaveList = document.getElementById('leave-list');
                leaveList.innerHTML = '';
                const userLeaves = allPublicLeaves.filter(leave => leave.userId === userId);

                if (userLeaves.length === 0) {
                    leaveList.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีคำขอวันหยุด</p>';
                } else {
                    userLeaves.forEach(data => {
                        const statusClass = data.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            data.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const item = document.createElement('div');
                        item.className = 'p-4 border-b border-gray-200';
                        item.innerHTML = `
                            <p class="text-gray-700"><strong>วันที่:</strong> ${data.startDate} ถึง ${data.endDate}</p>
                            <p class="text-gray-700"><strong>เหตุผล:</strong> ${data.reason}</p>
                            <p class="text-gray-700"><strong>สถานะ:</strong> <span class="inline-block rounded-full px-3 py-1 text-sm font-semibold ${statusClass}">${data.status === 'pending' ? 'รออนุมัติ' : data.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ'}</span></p>
                        `;
                        leaveList.appendChild(item);
                    });
                }
                if (userData.department === 'ฝ่ายบุคคล') {
                    renderPendingLeaves(allPublicLeaves);
                }
            });

            // Listen for advance requests
            onSnapshot(advanceRequestsCollection, (snapshot) => {
                allAdvanceRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update payroll page total deduction
                const userAdvanceDeduction = allAdvanceRequests
                    .filter(req => req.userId === userId && req.status === 'approved')
                    .reduce((total, req) => total + req.amount, 0);

                document.getElementById('total-advance-deduction').innerText = userAdvanceDeduction;

                if (userData.department === 'ฝ่ายบุคคล') {
                    renderPendingAdvanceRequests(allAdvanceRequests);
                    renderAdvanceReport(allAdvanceRequests);
                }
            });

            // Listen for attendance data
            const userAttendanceDocRef = doc(attendanceCollection, userId);
            onSnapshot(userAttendanceDocRef, (docSnap) => {
                const checkinData = docSnap.exists() ? docSnap.data() : {};
                const today = new Date();
                renderCheckinCalendar(userId, today.getMonth(), today.getFullYear(), checkinData);
            });


            document.getElementById('calendar-month-year').innerText = `${monthNames[currentMonth]} ${currentYear}`;
            document.getElementById('prev-month').addEventListener('click', () => {
                if (currentMonth === 0) {
                    currentMonth = 11;
                    currentYear--;
                } else {
                    currentMonth--;
                }
                document.getElementById('calendar-month-year').innerText = `${monthNames[currentMonth]} ${currentYear}`;
                // Re-render calendar with new month's leaves from the already-fetched data
                renderCalendar(currentMonth, currentYear, allPublicLeaves);
            });

            document.getElementById('next-month').addEventListener('click', () => {
                if (currentMonth === 11) {
                    currentMonth = 0;
                    currentYear++;
                } else {
                    currentMonth++;
                }
                document.getElementById('calendar-month-year').innerText = `${monthNames[currentMonth]} ${currentYear}`;
                // Re-render calendar with new month's leaves from the already-fetched data
                renderCalendar(currentMonth, currentYear, allPublicLeaves);
            });
        };
        
        window.checkIn = async () => {
            const userId = loggedInUser?.uid;
            if (!userId) {
                showModal('โปรดเข้าสู่ระบบก่อน');
                return;
            }
            const today = new Date();
            const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const timeString = today.toLocaleTimeString('th-TH');
            
            const attendanceDocRef = doc(db, `artifacts/${appId}/public/data/attendance`, userId);
            try {
                await setDoc(attendanceDocRef, {
                    [dateString]: {
                        checkIn: timeString,
                        date: dateString,
                        checkOut: null
                    }
                }, { merge: true });
                showModal('เช็คอินสำเร็จ!');
            } catch (e) {
                console.error("Error checking in:", e);
                showModal('เกิดข้อผิดพลาดในการเช็คอิน');
            }
        };
        
        window.checkOut = async () => {
            const userId = loggedInUser?.uid;
            if (!userId) {
                showModal('โปรดเข้าสู่ระบบก่อน');
                return;
            }
            const today = new Date();
            const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const timeString = today.toLocaleTimeString('th-TH');
            
            const attendanceDocRef = doc(db, `artifacts/${appId}/public/data/attendance`, userId);
            try {
                await setDoc(attendanceDocRef, {
                    [dateString]: {
                        checkOut: timeString,
                    }
                }, { merge: true });
                showModal('เช็คเอาท์สำเร็จ!');
            } catch (e) {
                console.error("Error checking out:", e);
                showModal('เกิดข้อผิดพลาดในการเช็คเอาท์');
            }
        };

        window.submitLeaveRequest = async () => {
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const reason = document.getElementById('leave-reason').value;

            if (!startDate || !endDate || !reason) {
                showModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            const userId = loggedInUser?.uid;
            const userName = document.getElementById('employee-name').innerText;
            if (!userId) {
                showModal('โปรดเข้าสู่ระบบก่อน');
                return;
            }

            // Check for the 3-person limit ONLY for the ADMIN department
            if (loggedInUserDepartment === 'ADMIN') {
                try {
                    const leavesOnThisDate = allPublicLeaves.filter(leave => 
                        leave.startDate === startDate && leave.status === 'pending'
                    );
                    if (leavesOnThisDate.length >= 3) {
                        showModal('ไม่สามารถยื่นคำขอในวันนี้ได้ เนื่องจากมีคำขอรออนุมัติครบ 3 คนแล้ว');
                        return;
                    }
                } catch (e) {
                    console.error("Error checking leave limit:", e);
                    showModal('เกิดข้อผิดพลาดในการตรวจสอบจำนวนคำขอวันหยุด');
                    return;
                }
            }

            try {
                // Add document to the public collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/leave_requests_public`), {
                    userId,
                    userName,
                    department: loggedInUserDepartment,
                    startDate,
                    endDate,
                    reason,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                showModal('ส่งคำขอวันหยุดสำเร็จแล้ว!');
                document.getElementById('leave-form').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal('เกิดข้อผิดพลาดในการส่งคำขอ');
            }
        };

        window.submitAdvanceRequest = async () => {
            const amount = document.getElementById('advance-amount').value;
            const reason = document.getElementById('advance-reason').value;

            if (!amount || !reason) {
                showModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            const userId = loggedInUser?.uid;
            const userName = document.getElementById('employee-name').innerText;
            const department = document.getElementById('employee-department').innerText;
            if (!userId) {
                showModal('โปรดเข้าสู่ระบบก่อน');
                return;
            }

            const today = new Date();
            const day = today.getDate();
            const payPeriod = day <= 15 ? 'รอบวันที่ 10' : 'รอบวันที่ 20';

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/advance_requests_public`), {
                    userId,
                    userName,
                    department,
                    amount: parseInt(amount, 10),
                    reason,
                    payPeriod,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                showModal('ส่งคำขอเบิกเงินล่วงหน้าสำเร็จแล้ว!');
                document.getElementById('advance-form').reset();
            } catch (e) {
                console.error("Error adding advance request: ", e);
                showModal('เกิดข้อผิดพลาดในการส่งคำขอเบิกเงินล่วงหน้า');
            }
        };


        // --- HR Management Functions ---
        let allEmployees = {};

        const loadEmployeeData = async () => {
            const employeesList = document.getElementById('employees-list');
            employeesList.innerHTML = '<p class="text-center text-gray-500">กำลังโหลดข้อมูล...</p>';
            try {
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const userDocs = await getDocs(usersCollectionRef);

                allEmployees = {};
                const employeeListHtml = [];
                userDocs.forEach(doc => {
                    const userId = doc.id;
                    const profileData = doc.data().profile.data;
                    allEmployees[userId] = profileData;
                    const payslipBtnText = profileData.isPayslipVisible ? 'ปิดสลิป' : 'แสดงสลิป';
                    const payslipBtnColor = profileData.isPayslipVisible ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                    employeeListHtml.push(`
                        <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                            <div>
                                <p class="font-semibold text-gray-800">${profileData.name}</p>
                                <p class="text-sm text-gray-600">${profileData.department} / ${profileData.position}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="togglePayslipVisibility('${userId}')" class="px-3 py-1 text-sm font-medium rounded-md text-white ${payslipBtnColor}">${payslipBtnText}</button>
                                <button onclick="editEmployee('${userId}')" class="px-3 py-1 text-sm font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600">แก้ไข</button>
                            </div>
                        </div>
                    `);
                });
                employeesList.innerHTML = employeeListHtml.join('');
            } catch (e) {
                console.error("Error loading employee data for HR:", e);
                employeesList.innerHTML = '<p class="text-center text-red-500">ไม่สามารถโหลดข้อมูลพนักงานได้</p>';
            }
        };

        const renderPendingLeaves = (leaves) => {
            const pendingList = document.getElementById('pending-leaves-list');
            pendingList.innerHTML = '';
            const pendingLeaves = leaves.filter(leave => leave.status === 'pending');
            if (pendingLeaves.length === 0) {
                pendingList.innerHTML = '<p class="text-center text-gray-500">ไม่มีคำขอที่รอการอนุมัติ</p>';
            } else {
                pendingLeaves.forEach(leave => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${leave.userName} (${leave.department})</p>
                            <p class="text-sm text-gray-600">วันที่: ${leave.startDate} ถึง ${leave.endDate}</p>
                            <p class="text-sm text-gray-600">เหตุผล: ${leave.reason}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveLeave('${leave.id}')" class="px-3 py-1 text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600">อนุมัติ</button>
                            <button onclick="rejectLeave('${leave.id}')" class="px-3 py-1 text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600">ไม่อนุมัติ</button>
                        </div>
                    `;
                    pendingList.appendChild(item);
                });
            }
        };
        
        const renderPendingAdvanceRequests = (requests) => {
            const pendingList = document.getElementById('pending-advance-list');
            pendingList.innerHTML = '';
            const pendingRequests = requests.filter(req => req.status === 'pending');
            if (pendingRequests.length === 0) {
                pendingList.innerHTML = '<p class="text-center text-gray-500">ไม่มีคำขอเบิกเงินล่วงหน้า</p>';
            } else {
                pendingRequests.forEach(req => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${req.userName} (${req.department})</p>
                            <p class="text-sm text-gray-600">จำนวน: ${req.amount} บาท</p>
                            <p class="text-sm text-gray-600">เหตุผล: ${req.reason}</p>
                            <p class="text-sm text-gray-600">รอบการเบิก: ${req.payPeriod}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveAdvance('${req.id}')" class="px-3 py-1 text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600">อนุมัติ</button>
                            <button onclick="rejectAdvance('${req.id}')" class="px-3 py-1 text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600">ไม่อนุมัติ</button>
                        </div>
                    `;
                    pendingList.appendChild(item);
                });
            }
        };

        const renderAdvanceReport = (requests) => {
            const reportList = document.getElementById('advance-report-list');
            reportList.innerHTML = '';
            const approvedRequests = requests.filter(req => req.status === 'approved');
            
            if (approvedRequests.length === 0) {
                reportList.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการเบิกเงินล่วงหน้า</p>';
                return;
            }

            const reportData = {};
            approvedRequests.forEach(req => {
                const userId = req.userId;
                if (!reportData[userId]) {
                    reportData[userId] = {
                        userName: req.userName,
                        department: req.department,
                        period10: 0,
                        period20: 0,
                        total: 0
                    };
                }
                if (req.payPeriod === 'รอบวันที่ 10') {
                    reportData[userId].period10 += req.amount;
                } else if (req.payPeriod === 'รอบวันที่ 20') {
                    reportData[userId].period20 += req.amount;
                }
                reportData[userId].total += req.amount;
            });

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ชื่อพนักงาน</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">แผนก</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ยอดเบิก<br>รอบวันที่ 10</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ยอดเบิก<br>รอบวันที่ 20</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ยอดรวมทั้งหมด</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            for (const userId in reportData) {
                const data = reportData[userId];
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.department}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.period10} บาท</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.period20} บาท</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${data.total} บาท</td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            reportList.innerHTML = tableHtml;
        };


        window.approveLeave = async (leaveId) => {
            const leaveRef = doc(db, `artifacts/${appId}/public/data/leave_requests_public`, leaveId);
            try {
                await setDoc(leaveRef, { status: 'approved' }, { merge: true });
                showModal('อนุมัติคำขอวันหยุดสำเร็จแล้ว');
            } catch (e) {
                console.error("Error approving leave:", e);
                showModal('เกิดข้อผิดพลาดในการอนุมัติ');
            }
        };

        window.rejectLeave = async (leaveId) => {
            const leaveRef = doc(db, `artifacts/${appId}/public/data/leave_requests_public`, leaveId);
            try {
                await setDoc(leaveRef, { status: 'rejected' }, { merge: true });
                showModal('ไม่อนุมัติคำขอวันหยุดสำเร็จแล้ว');
            } catch (e) {
                console.error("Error rejecting leave:", e);
                showModal('เกิดข้อผิดพลาดในการไม่อนุมัติ');
            }
        };
        
        window.approveAdvance = async (advanceId) => {
            const advanceRef = doc(db, `artifacts/${appId}/public/data/advance_requests_public`, advanceId);
            try {
                await setDoc(advanceRef, { status: 'approved' }, { merge: true });
                showModal('อนุมัติการเบิกเงินล่วงหน้าสำเร็จแล้ว');
            } catch (e) {
                console.error("Error approving advance request:", e);
                showModal('เกิดข้อผิดพลาดในการอนุมัติ');
            }
        };

        window.rejectAdvance = async (advanceId) => {
            const advanceRef = doc(db, `artifacts/${appId}/public/data/advance_requests_public`, advanceId);
            try {
                await setDoc(advanceRef, { status: 'rejected' }, { merge: true });
                showModal('ไม่อนุมัติการเบิกเงินล่วงหน้าสำเร็จแล้ว');
            } catch (e) {
                console.error("Error rejecting advance request:", e);
                showModal('เกิดข้อผิดพลาดในการไม่อนุมัติ');
            }
        };

        window.editEmployee = (userId) => {
            const employeeData = allEmployees[userId];
            if (!employeeData) {
                showModal('ไม่พบข้อมูลพนักงาน');
                return;
            }
            
            document.getElementById('hr-form-title').innerText = 'แก้ไขข้อมูลพนักงาน';
            document.getElementById('hr-form-submit-btn').innerText = 'บันทึกการแก้ไข';
            document.getElementById('hr-form-employee-id').value = employeeData.employeeId || '';
            document.getElementById('hr-form-password').value = employeeData.password;
            document.getElementById('hr-form-name').value = employeeData.name;
            document.getElementById('hr-form-position').value = employeeData.position;
            document.getElementById('hr-form-department').value = employeeData.department;
            document.getElementById('hr-form-start-date').value = employeeData.startDate;
            document.getElementById('hr-form-base-salary').value = employeeData.baseSalary;
            document.getElementById('hr-form-meal-allowance-rate').value = employeeData.mealAllowanceRate;
            document.getElementById('hr-form-travel-allowance').value = employeeData.travelAllowance;
            document.getElementById('hr-form-commission').value = employeeData.commission;
            document.getElementById('hr-form-working-days').value = employeeData.workingDays;
            document.getElementById('hr-form-miscellaneous-fee').value = employeeData.miscellaneousFee;
            document.getElementById('hr-form-advance-deduction').value = employeeData.advanceDeduction;

            // Use a hidden field to store the user ID for editing
            document.getElementById('hr-form-user-id').value = userId;

            // Scroll to the form
            document.getElementById('hr-form-section').scrollIntoView({ behavior: 'smooth' });
        };

        window.submitHrForm = async () => {
            const form = document.getElementById('hr-form');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = key.includes('salary') || key.includes('allowance') || key.includes('commission') || key.includes('days') || key.includes('deduction') || key.includes('fee') ? Number(value) : value;
            });
            const userId = document.getElementById('hr-form-user-id').value;
            const newEmployeeId = data.employeeId;

            if (!newEmployeeId || !data.password || !data.name) {
                showModal('กรุณา ก รอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }

            try {
                if (userId) {
                    // Editing existing user
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    await setDoc(userDocRef, data);
                    showModal('แก้ไขข้อมูลพนักงานสำเร็จ');
                } else {
                    // Adding new user
                    // Note: This approach requires a way to map the hardcoded employeeId to a new Firebase user.
                    // For this single-file demo, we'll store the employeeId as part of the profile data.
                    const newUserRef = doc(collection(db, `artifacts/${appId}/users`), 'placeholder-id');
                    await setDoc(newUserRef, { profile: { data } }); // Use a nested structure
                    showModal('เพิ่มข้อมูลพนักงานใหม่สำเร็จ');
                }
                form.reset();
                document.getElementById('hr-form-user-id').value = ''; // Reset for new entry
                loadEmployeeData(); // Reload list
            } catch (e) {
                console.error("Error saving employee data:", e);
                showModal('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        };

        // Modal for custom alerts
        window.showModal = (message) => {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.innerText = message;
            modal.classList.remove('hidden');
        };

        window.hideModal = () => {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
        };
        
        window.showPayrollBreakdown = async () => {
            const breakdownDiv = document.getElementById('payroll-breakdown-details');
            const button = document.getElementById('show-breakdown-btn');
            
            if (breakdownDiv.classList.contains('hidden')) {
                // Fetch the latest user data to ensure the calculation is correct
                const userId = loggedInUser.uid;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                const userDocSnap = await getDoc(userDocRef);
                const userData = userDocSnap.data();

                const workingDays = userData.workingDays;
                const baseSalary = userData.baseSalary;
                const mealAllowanceRate = userData.mealAllowanceRate;
                const travelAllowance = userData.travelAllowance;
                const commission = userData.commission;
                const miscellaneousFee = userData.miscellaneousFee;
                const advanceDeduction = userData.advanceDeduction;

                const mealAllowance = mealAllowanceRate * workingDays;
                const otWorkingDays = Math.max(0, workingDays - 25);
                const otPay = (baseSalary / 25) * otWorkingDays;
                const totalIncome = baseSalary + mealAllowance + travelAllowance + otPay + commission + miscellaneousFee;
                const totalDeduction = advanceDeduction + miscellaneousFee;
                const netPay = totalIncome - totalDeduction;

                breakdownDiv.innerHTML = `
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-semibold text-lg text-blue-800 mb-2">รายละเอียดการคำนวณ</h4>
                        <div class="space-y-2 text-sm text-gray-700">
                            <p><strong>- รายรับ:</strong></p>
                            <ul class="list-disc pl-6 space-y-1">
                                <li><strong>ฐานเงินเดือน:</strong> ${baseSalary.toFixed(2)} บาท</li>
                                <li><strong>ค่าข้าว:</strong> ${mealAllowanceRate.toFixed(2)} บาท/วัน x ${workingDays} วัน = ${mealAllowance.toFixed(2)} บาท</li>
                                <li><strong>ค่าเดินทาง:</strong> ${travelAllowance.toFixed(2)} บาท</li>
                                <li><strong>OT:</strong> (${baseSalary.toFixed(2)} / 25 วัน) x ${otWorkingDays} วัน = ${otPay.toFixed(2)} บาท</li>
                                <li><strong>ค่าคอมมิชชั่น:</strong> ${commission.toFixed(2)} บาท</li>
                                <li><strong>ค่าทำรายการ:</strong> ${miscellaneousFee.toFixed(2)} บาท</li>
                                <li class="font-bold text-green-700"><strong>รวมรายรับทั้งหมด:</strong> ${totalIncome.toFixed(2)} บาท</li>
                            </ul>
                        </div>
                        <div class="space-y-2 text-sm text-gray-700 mt-4">
                            <p><strong>- รายการหัก:</strong></p>
                            <ul class="list-disc pl-6 space-y-1">
                                <li><strong>รายการเบิก:</strong> ${advanceDeduction.toFixed(2)} บาท</li>
                                <li><strong>หักค่าทำรายการผิด:</strong> ${miscellaneousFee.toFixed(2)} บาท</li>
                                <li class="font-bold text-red-700"><strong>รวมหักทั้งหมด:</strong> ${totalDeduction.toFixed(2)} บาท</li>
                            </ul>
                        </div>
                        <div class="mt-4 pt-4 border-t border-blue-200 text-lg font-bold text-blue-800">
                            <p><strong>รายรับสุทธิ:</strong> ${totalIncome.toFixed(2)} - ${totalDeduction.toFixed(2)} = ${netPay.toFixed(2)} บาท</p>
                        </div>
                    </div>
                `;
                breakdownDiv.classList.remove('hidden');
                button.innerText = 'ซ่อนรายละเอียดการคำนวณ';
            } else {
                breakdownDiv.classList.add('hidden');
                button.innerText = 'แสดงรายละเอียดการคำนวณ';
            }
        };
        
        window.togglePayslipVisibility = async (userId) => {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().isPayslipVisible || false;
                    await setDoc(userDocRef, { isPayslipVisible: !currentStatus }, { merge: true });
                    const action = currentStatus ? 'ปิด' : 'แสดง';
                    showModal(`สำเร็จ! ${action}สลิปเงินเดือนของพนักงานเรียบร้อยแล้ว`);
                } else {
                    showModal('ไม่พบข้อมูลพนักงาน');
                }
            } catch (e) {
                console.error("Error toggling payslip visibility:", e);
                showModal('เกิดข้อผิดพลาดในการดำเนินการ');
            }
        };
    </script>
</head>

<body class="bg-gray-100 font-sans p-4 flex flex-col items-center">

    <!-- Loading State -->
    <div id="loading-state" class="flex flex-col items-center justify-center h-screen w-full">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-600">กำลังเชื่อมต่อ...</p>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="hidden w-full max-w-sm bg-white rounded-xl shadow-lg p-6 space-y-6 flex flex-col items-center">
        <h1 class="text-3xl font-bold text-gray-800 text-center">เข้าสู่ระบบ</h1>
        <form id="login-form" class="w-full space-y-4">
            <div>
                <label for="employee-id" class="block text-sm font-medium text-gray-700">รหัสพนักงาน</label>
                <input type="text" id="employee-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="suc@eyeyhaa">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน 6 หลัก</label>
                <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="******" maxlength="6">
            </div>
            <button type="button" onclick="loginUser()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 ease-in-out">
                เข้าสู่ระบบ
            </button>
        </form>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 space-y-8">
        <div class="flex flex-col sm:flex-row justify-between items-center border-b pb-4 mb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 sm:mb-0">ระบบพนักงาน</h1>
            <div class="flex items-center space-x-4">
                <div class="text-gray-600 text-sm">รหัสผู้ใช้: <span id="user-id-display" class="font-mono text-xs text-blue-500"></span></div>
                <button onclick="logoutUser()" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                    ออกจากระบบ
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex justify-center border-b-2 border-gray-200">
            <button id="tab-employee-info" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out">ข้อมูลพนักงาน</button>
            <button id="tab-payroll" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out">ข้อมูลเงินเดือน</button>
            <button id="tab-leave" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out">วันหยุด</button>
            <button id="tab-advance" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out">เบิกเงินล่วงหน้า</button>
            <button id="tab-hr" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out hidden">จัดการข้อมูลพนักงาน</button>
            <button id="tab-approve-leave" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out hidden">อนุมัติวันหยุด</button>
            <button id="tab-approve-advance" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out hidden">อนุมัติเบิกเงิน</button>
            <button id="tab-advance-report" class="py-2 px-6 text-lg font-medium text-gray-700 border-b-4 border-transparent hover:border-blue-500 transition-colors duration-200 ease-in-out hidden">รายงานยอดเบิก</button>
        </div>

        <!-- Employee Info Section -->
        <div id="section-employee-info" class="tab-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">ข้อมูลส่วนตัว</h2>
            <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                <p class="text-gray-700"><strong class="font-semibold">ชื่อ-นามสกุล:</strong> <span id="employee-name"></span></p>
                <p class="text-gray-700"><strong class="font-semibold">แผนก/ตำแหน่ง:</strong> <span id="employee-department"></span> / <span id="employee-position"></span></p>
                <p class="text-gray-700"><strong class="font-semibold">วันเริ่มงาน:</strong> <span id="employee-start-date"></span></p>
            </div>
            
            <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">สถานะการเข้างาน</h2>
            <div class="bg-gray-50 rounded-lg p-4 shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="checkin-month-year" class="text-lg font-semibold text-gray-800"></h3>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-500">
                    <span>อา.</span><span>จ.</span><span>อ.</span><span>พ.</span><span>พฤ.</span><span>ศ.</span><span>ส.</span>
                </div>
                <div id="checkin-calendar-days" class="grid grid-cols-7 gap-1 mt-2">
                    <!-- Check-in calendar days will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Payroll Section -->
        <div id="section-payroll" class="tab-section hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">ข้อมูลเงินเดือน</h2>
            <div id="payroll-details" class="bg-gray-50 rounded-lg p-6 space-y-4">
                <p id="payslip-status-message" class="text-center text-gray-500 hidden">สลิปเงินเดือนยังไม่พร้อมใช้งาน กรุณาติดต่อฝ่ายบุคคล</p>
                <div id="payroll-list" class="max-h-96 overflow-y-auto hidden">
                    <!-- Payroll data will be loaded here -->
                </div>
                 <button id="show-breakdown-btn" onclick="showPayrollBreakdown()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-semibold text-white bg-gray-500 hover:bg-gray-600 transition-colors duration-200 ease-in-out mt-4">
                    แสดงรายละเอียดการคำนวณ
                </button>
                <div id="payroll-breakdown-details" class="hidden">
                    <!-- Detailed calculation breakdown will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- Leave Section -->
        <div id="section-leave" class="tab-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Calendar Section -->
                <div class="bg-gray-50 rounded-lg p-4 shadow">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="calendar-month-year" class="text-lg font-semibold text-gray-800"></h3>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-500">
                        <span>อา.</span><span>จ.</span><span>อ.</span><span>พ.</span><span>พฤ.</span><span>ศ.</span><span>ส.</span>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-1 mt-2">
                        <!-- Calendar days will be rendered here -->
                    </div>
                </div>

                <!-- Leave Request Form -->
                <div class="bg-gray-50 rounded-lg p-6 shadow space-y-4">
                    <h2 class="text-2xl font-semibold text-gray-700">ยื่นคำขอวันหยุด</h2>
                    <form id="leave-form" class="space-y-4">
                        <div>
                            <label for="leave-start-date" class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                            <input type="date" id="leave-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="leave-end-date" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                            <input type="date" id="leave-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="leave-reason" class="block text-sm font-medium text-gray-700">เหตุผล</label>
                            <textarea id="leave-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
                        </div>
                        <button type="button" onclick="submitLeaveRequest()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 ease-in-out">
                            ส่งคำขอวันหยุด
                        </button>
                    </form>
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">สถานะคำขอวันหยุดของคุณ</h2>
            <div id="leave-list" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                <!-- Leave requests will be loaded here -->
            </div>
        </div>

        <!-- Advance Request Section -->
        <div id="section-advance" class="tab-section hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">เบิกเงินล่วงหน้า</h2>
            <div class="bg-gray-50 rounded-lg p-6 shadow space-y-4">
                <form id="advance-form" class="space-y-4">
                    <div>
                        <label for="advance-amount" class="block text-sm font-medium text-gray-700">จำนวนเงินที่ต้องการเบิก</label>
                        <input type="number" id="advance-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="เช่น 1000">
                    </div>
                    <div>
                        <label for="advance-reason" class="block text-sm font-medium text-gray-700">เหตุผลในการเบิก</label>
                        <textarea id="advance-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
                    </div>
                    <button type="button" onclick="submitAdvanceRequest()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 ease-in-out">
                            ส่งคำขอเบิกเงินล่วงหน้า
                        </button>
                    </form>
                </div>
                <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">รายการเบิกเงินล่วงหน้าของคุณ</h2>
                <div id="advance-list" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center">ยังไม่มีรายการเบิกเงินล่วงหน้า</p>
                </div>
            </div>

            <!-- HR Management Section -->
            <div id="section-hr" class="tab-section hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">จัดการข้อมูลพนักงาน</h2>
                <div class="bg-gray-50 rounded-lg p-6 space-y-6 shadow-md">
                    <h3 id="hr-form-title" class="text-xl font-bold text-gray-800">เพิ่มข้อมูลพนักงานใหม่</h3>
                    <form id="hr-form" class="space-y-4">
                        <input type="hidden" id="hr-form-user-id" name="userId">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="hr-form-employee-id" class="block text-sm font-medium text-gray-700">รหัสพนักงาน</label>
                                <input type="text" id="hr-form-employee-id" name="employeeId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="hr-form-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (6 หลัก)</label>
                                <input type="password" id="hr-form-password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" maxlength="6">
                            </div>
                        </div>
                        <div>
                            <label for="hr-form-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                            <input type="text" id="hr-form-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="hr-form-department" class="block text-sm font-medium text-gray-700">แผนก</label>
                                <input type="text" id="hr-form-department" name="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="hr-form-position" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                                <input type="text" id="hr-form-position" name="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                        </div>
                        <div>
                            <label for="hr-form-start-date" class="block text-sm font-medium text-gray-700">วันเริ่มงาน (วว/ดด/ปปปป)</label>
                            <input type="text" id="hr-form-start-date" name="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="hr-form-base-salary" class="block text-sm font-medium text-gray-700">ฐานเงินเดือน</label>
                                <input type="number" id="hr-form-base-salary" name="baseSalary" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="hr-form-meal-allowance-rate" class="block text-sm font-medium text-gray-700">ค่าข้าว/วัน</label>
                                <input type="number" id="hr-form-meal-allowance-rate" name="mealAllowanceRate" class="mt-1 block w-full rounded-md border-
